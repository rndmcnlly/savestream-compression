<html>
  <head>
    <style>
      #report_area {
        border: thin solid black;
        border-radius: 1ex;
        margin: 1ex;
        padding: 1ex;
      }
    </style>
  </head>
  <body>
    <button id="load_files_button">load files</button>

    <progress id="progress_bar" max="100" value="0"></progress>
    <div id="report_area">Load files to see a report about them.</div>

    <script src="savestreams.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@msgpack/msgpack@3.0.0-beta3/dist.es5+umd/msgpack.min.js"></script>
    <script>
      let button = document.getElementById("load_files_button");
      button.onclick = async function () {
        const handles = await window.showOpenFilePicker({
          multiple: true,
        });

        const reportArea = document.getElementById("report_area");
        const progressBar = document.getElementById("progress_bar");
        reportArea.innerHTML = "";

        const uniqueBlockIds = new Map();
        const fileReports = [];
        const numHandles = handles.length;
        
        const frames = [];
        
        for (let i = 0; i < numHandles; i++) {
          const handle = handles[i];
          let file = await handle.getFile();
          let buffer = await file.arrayBuffer();  
          
          const {header, infoSegment, bufferSegment} = unpack(buffer);
          const blockSize = 256;
          const alignedBufferSegment = align(infoSegment, bufferSegment, blockSize);
          const {newBlocks, blockSequence} = deduplicate(alignedBufferSegment, uniqueBlockIds, blockSize);
          
          const frame = {
            header,
            infoSegment,
            blockSize,
            newBlocks,
            blockSequence,
          };
          
          frames.push(frame);
          
          fileReports.push({
            name: file.name,
            length: MessagePack.encode(frame).length,
          });
          
          progressBar.value = (100 * (i + 1)) / numHandles;
        }
        
        fileReports.forEach((report) => {
          const div = document.createElement("div");
          div.innerHTML = `${report.name}: ${JSON.stringify(report)}`;
          reportArea.append(div);
        });

        let saveHandle = await window.showSaveFilePicker({
          startIn: "downloads",
          suggestedName: "last.savestream"
        });
        let writeableHandle = await saveHandle.createWritable();
        await writeableHandle.write(new TextEncoder().encode("meow\n").buffer);
        await writeableHandle.close();
      };
      
    </script>
  </body>
</html>
