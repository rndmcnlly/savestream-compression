<html>
  <head>
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #f5f5f5;
        padding: 20px; 
      }
      
      button {
        margin-top: 10px;
        background: #007bff;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.3s;
      }

      button:hover {
        background: #0056b3;
      }
    </style>
  </head>
  <script src="savestreams.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@msgpack/msgpack@3.0.0-beta3/dist.es5+umd/msgpack.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
  <body>
    <header>Inspector</header>
    <p>give me your .savestream file!</p>
    <button id="load_files_button">load .savestream file</button>
    <div id="chart"></div>
    <script>
      let button = document.getElementById("load_files_button");
      button.onclick = async function () {
        const handle = await window.showOpenFilePicker({
          multiple: false,
        });

        const file = await handle[0].getFile();
        const contents = await file.arrayBuffer();
        const frames = MessagePack.decode(contents);
        
        for (let frame of frames) {
        let tempNB = MessagePack.encode(frame.newBlocks).byteLength
        let tempH = MessagePack.encode(frame.header).byteLength
        let tempIS = MessagePack.encode(frame.infoSegment).byteLength
        let tempBS = MessagePack.encode(frame.blockSequence).byteLength
        console.log(tempNB, tempH, tempIS, tempBS)
        }

        
        const transformedData = frames.flatMap((obj, index) => [
          { segment: "header", size: MessagePack.encode(obj.header).byteLength, object_id: `Frame ${index + 1}` },
          { segment: "infoSegment", size: MessagePack.encode(obj.infoSegment).byteLength, object_id: `Frame ${index + 1}` },
          { segment: "newBlocks", size: MessagePack.encode(obj.newBlocks).byteLength, object_id: `Frame ${index + 1}` },
          { segment: "blockSequence", size: MessagePack.encode(obj.blockSequence).byteLength, object_id: `Frame ${index + 1}` }
        ]);
        
        // Vega-Lite chart specification
        const spec = {
            "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
            "data": { "values": transformedData },
            "mark": "bar",
            "width": 600,
            "height": 400,
            "encoding": {
                "x": { 
                    "field": "object_id", 
                    "type": "ordinal", 
                    "title": "Frame ID" 
                },
                "xOffset": { 
                    "field": "segment",
                    "type": "nominal" 
                },
                "y": { 
                    "field": "size", 
                    "type": "quantitative", 
                    "title": "Segment Size in Bytes",
                    "scale": {"type": "symlog", "constant": 100,  // Adjust this value for better spacing}
                },
                y2: { value: 1 },
                "color": { 
                    "field": "segment", 
                    "type": "nominal", 
                    "legend": { "title": "Segment Type" }
                },
                "tooltip": [{ "field": "segment" }, { "field": "size" }]
            }
        };

        // Render Vega-Lite chart
        vegaEmbed("#chart", spec);
      };
    </script>
  </body>
</html>